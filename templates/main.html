<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patho Return</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ app_version }}">
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css" />
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="header-left">
            <span class="logo"><i class="ph-bold ph-cube"></i> Patho Return</span>
        </div>
        <div class="header-right">
            <div class="status-badges">
                {% if overdue_count > 0 %}
                <span class="badge badge-danger">
                    期限超過 {{ overdue_count }}件
                </span>
                {% endif %}
                {% if unreturned_count > 0 %}
                <span class="badge badge-warning">
                    未返却 {{ unreturned_count }}件
                </span>
                {% endif %}
                <span class="badge {{ 'badge-success' if storage_status.connected else 'badge-danger' }}">
                    {{ 'USB' if storage_status.type == 'usb' else 'NAS' }}: {{ '接続中' if storage_status.connected else '未接続' }}
                </span>
            </div>
            <span class="user-badge">{{ user.name }}</span>
            <a href="{{ url_for('settings') }}" class="btn btn-secondary btn-sm">設定</a>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">ログアウト</a>
        </div>
    </header>

    <main class="main-container">
        <!-- メインタブ -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="scan" onclick="switchMainTab('scan')">
                <i class="ph ph-barcode"></i> スキャン登録
            </button>
            <button class="main-tab" data-tab="return" onclick="switchMainTab('return')">
                <i class="ph ph-arrow-u-up-left"></i> 返却処理
                <span class="tab-badge" id="incompleteCount">0</span>
            </button>
        </div>

        <!-- ============================================================
             タブ1: スキャン登録
             ============================================================ -->
        <div class="tab-content active" id="tabScan">
            <!-- スキャン入力カード -->
            <div class="card scan-card">
                <div class="card-body">
                    <form id="scanForm" onsubmit="submitScan(event)">
                        <!-- メインバーコード入力エリア -->
                        <div class="barcode-input-wrapper" id="barcodeWrapper">
                            <div class="barcode-icon">
                                <i class="ph-bold ph-barcode"></i>
                            </div>
                            <input type="text"
                                   class="barcode-input"
                                   id="barcodeInput"
                                   placeholder="バーコードをスキャン..."
                                   autocomplete="off">
                            <div class="scan-indicator">
                                <i class="ph ph-scan"></i>
                                <span>スキャン待機中</span>
                            </div>
                        </div>

                        <!-- 患者ID入力エリア -->
                        <div class="barcode-input-wrapper" id="patientIdWrapper" style="margin-top: 20px;">
                            <div class="barcode-icon">
                                <i class="ph-bold ph-user"></i>
                            </div>
                            <input type="text"
                                   class="barcode-input"
                                   id="patientIdInput"
                                   placeholder="患者IDをスキャン（任意）..."
                                   autocomplete="off">
                            <div class="scan-indicator">
                                <i class="ph ph-identification-card"></i>
                                <span>任意</span>
                            </div>
                        </div>

                        <!-- サブ入力エリア -->
                        <div class="sub-inputs">
                            <div class="sub-input-group">
                                <label class="form-label">個数</label>
                                <div class="quantity-stepper">
                                    <button type="button" class="stepper-btn" onclick="updateQuantity(-1)">
                                        <i class="ph-bold ph-minus"></i>
                                    </button>
                                    <input type="number" class="form-input stepper-input" id="quantityInput"
                                           value="1" min="1" required readonly>
                                    <button type="button" class="stepper-btn" onclick="updateQuantity(1)">
                                        <i class="ph-bold ph-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="sub-input-group sub-input-memo">
                                <label class="form-label">メモ</label>
                                <input type="text" class="form-input" id="notesInput" placeholder="備考があれば入力...">
                            </div>
                            <button type="submit" class="btn btn-primary btn-register">
                                <i class="ph-bold ph-plus-circle"></i>
                                <span>登録</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 履歴カード -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <h2 class="card-title"><i class="ph ph-clock-counter-clockwise"></i> スキャン履歴</h2>
                    <div class="search-bar">
                        <input type="text" class="form-input search-input" id="searchInput"
                               placeholder="検索...">
                        <button class="btn btn-secondary btn-sm" onclick="loadHistory()">検索</button>
                        <a href="/export/csv" class="btn btn-success btn-sm" id="exportBtn">CSV</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- フィルタータブ -->
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all" onclick="setFilter('all')">
                            全件
                        </button>
                        <button class="filter-tab" data-filter="today" onclick="setFilter('today')">
                            今日
                        </button>
                        <button class="filter-tab" data-filter="yesterday" onclick="setFilter('yesterday')">
                            昨日
                        </button>
                        <button class="filter-tab" data-filter="unreturned" onclick="setFilter('unreturned')">
                            未返却
                            <span class="count" id="unreturnedCount">{{ unreturned_count }}</span>
                        </button>
                        <button class="filter-tab" data-filter="overdue" onclick="setFilter('overdue')">
                            期限超過
                            <span class="count" id="overdueCount">{{ overdue_count }}</span>
                        </button>
                        <button class="filter-tab sort-tab" data-sort="barcode" onclick="setSort('barcode')">
                            バーコード順
                        </button>
                    </div>

                    <!-- テーブル -->
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>バーコード</th>
                                    <th>患者ID</th>
                                    <th>個数</th>
                                    <th>スキャン者</th>
                                    <th>スキャン日時</th>
                                    <th>メモ</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ページネーション -->
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             タブ2: 返却処理
             ============================================================ -->
        <div class="tab-content" id="tabReturn">
            <!-- 返却スキャン入力カード -->
            <div class="card scan-card" style="margin-bottom: 20px;">
                <div class="card-body">
                    <div class="barcode-input-wrapper" id="returnBarcodeWrapper">
                        <div class="barcode-icon">
                            <i class="ph-bold ph-barcode"></i>
                        </div>
                        <input type="text"
                               class="barcode-input"
                               id="returnBarcodeInput"
                               placeholder="返却バーコードをスキャン..."
                               autocomplete="off">
                        <div class="scan-indicator">
                            <i class="ph ph-arrow-u-up-left"></i>
                            <span>返却スキャン</span>
                        </div>
                    </div>
                    <p class="return-scan-hint" style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">
                        <i class="ph ph-info"></i>
                        バーコードをスキャンすると、既存レコードにフォーカス、未登録の場合は新規作成します（返却処理は手動で行ってください）
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <h2 class="card-title"><i class="ph ph-arrow-u-up-left"></i> 返却処理</h2>
                    <div class="search-bar">
                        <input type="text" class="form-input search-input" id="returnSearchInput"
                               placeholder="バーコード・メモで検索...">
                        <select class="form-input" id="returnSortSelect" onchange="loadReturnList()">
                            <option value="newest">新しい順</option>
                            <option value="oldest">古い順</option>
                        </select>
                        <label class="toggle-completed">
                            <input type="checkbox" id="showCompletedToggle" onchange="loadReturnList()">
                            <span>完了を表示</span>
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 返却フィルタータブ -->
                    <div class="filter-tabs return-filter-tabs">
                        <button class="filter-tab active" data-filter="all" onclick="setReturnFilter('all')">
                            全件
                        </button>
                        <button class="filter-tab" data-filter="today" onclick="setReturnFilter('today')">
                            今日
                        </button>
                        <button class="filter-tab" data-filter="yesterday" onclick="setReturnFilter('yesterday')">
                            昨日
                        </button>
                        <button class="filter-tab sort-tab" data-sort="barcode" onclick="setReturnSort('barcode')">
                            バーコード順
                        </button>
                    </div>

                    <p class="return-hint">
                        <i class="ph ph-info"></i>
                        「完了」ボタンで返却完了（ブロック・スライドは任意）
                    </p>

                    <!-- 返却一覧テーブル -->
                    <div class="table-container">
                        <table class="table return-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>バーコード / メモ</th>
                                    <th style="width: 120px;">患者ID</th>
                                    <th style="width: 100px;">スキャン日</th>
                                    <th style="width: 90px;">仮報告</th>
                                    <th style="width: 90px;">結果</th>
                                    <th style="width: 110px;">ブロック</th>
                                    <th style="width: 110px;">スライド</th>
                                    <th style="width: 140px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="returnTable">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ページネーション -->
                    <div class="pagination" id="returnPagination"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="footer">
        <div class="footer-item">
            <span>{{ 'USB' if storage_status.type == 'usb' else 'NAS' }}:</span>
            <span class="badge {{ 'badge-success' if storage_status.connected else 'badge-danger' }}">
                {% if storage_status.connected %}
                    {{ storage_status.mount_point if storage_status.type == 'usb' else storage_status.host }}
                {% else %}
                    未接続
                {% endif %}
            </span>
        </div>
        <div class="footer-item">
            <span>最終バックアップ:</span>
            <span id="lastBackup">{{ last_backup.modified[:16] if last_backup else '未実行' }}</span>
        </div>
        <div class="footer-item">
            <button class="btn btn-secondary btn-sm" onclick="runBackup()">今すぐバックアップ</button>
        </div>
    </footer>

    <!-- 編集モーダル -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-pencil-simple"></i> 履歴編集</h3>
                <button class="modal-close" onclick="hideEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <div class="form-group mb-4">
                    <label class="form-label">バーコード</label>
                    <input type="text" class="form-input" id="editBarcode">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">患者ID</label>
                    <input type="text" class="form-input" id="editPatientId" placeholder="患者ID（任意）">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">個数</label>
                    <input type="number" class="form-input" id="editQuantity" min="1">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">仮報告</label>
                    <div class="toggle-group">
                        <label class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editPreliminaryReport">
                            <span>仮報告済み</span>
                        </label>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">結果返却</label>
                    <div class="toggle-group">
                        <label class="toggle-item">
                            <input type="checkbox" class="toggle-checkbox" id="editReturned">
                            <span>返却済み</span>
                        </label>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">ブロック個数</label>
                    <input type="number" class="form-input" id="editBlockQuantity" min="0" value="0">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">スライド個数</label>
                    <input type="number" class="form-input" id="editSlideQuantity" min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">メモ</label>
                    <input type="text" class="form-input" id="editNotes" placeholder="備考...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteItem()">削除</button>
                <button class="btn btn-secondary" onclick="hideEditModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 新規登録確認モーダル -->
    <div class="modal-overlay" id="confirmCreateModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-warning"></i> 新規登録の確認</h3>
                <button class="modal-close" onclick="hideConfirmCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">該当するレコードが見つかりませんでした。</p>
                <p style="margin-bottom: 16px;">以下のバーコードで新規登録しますか？</p>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center; margin-bottom: 16px;">
                    <strong id="confirmBarcode" style="font-size: 18px; font-family: monospace;"></strong>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px;">
                    <i class="ph ph-info"></i>
                    間違いの場合は「キャンセル」を押してください
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideConfirmCreateModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="confirmCreateReturn()">
                    <i class="ph ph-plus-circle"></i>
                    新規登録する
                </button>
            </div>
        </div>
    </div>

    <!-- トースト -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // 状態
        let currentFilter = 'all';
        let currentPage = 1;
        let currentSearch = '';
        let currentSort = 'newest';
        let returnPage = 1;
        let returnSearch = '';
        let returnFilter = 'all';
        let returnSort = 'newest';

        // 個数の増減
        function updateQuantity(change) {
            const input = document.getElementById('quantityInput');
            let val = parseInt(input.value) || 1;
            val += change;
            if (val < 1) val = 1;
            input.value = val;
        }

        // バーコード入力にフォーカスを当てる
        function focusBarcodeInput() {
            const input = document.getElementById('barcodeInput');
            if (input) {
                input.focus();
                input.select();
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadReturnList();
            updateIncompleteCount();

            // ページ読み込み時にバーコード入力にフォーカス
            setTimeout(focusBarcodeInput, 100);

            // バーコード入力でEnter → 患者IDにフォーカス移動
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('patientIdInput').focus();
                }
            });

            // 患者ID入力でEnter → 個数にフォーカス移動
            document.getElementById('patientIdInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('quantityInput').focus();
                }
            });

            // 個数入力でEnter → メモにフォーカス移動
            document.getElementById('quantityInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('notesInput').focus();
                }
            });

            // メモ入力でEnter → 登録実行
            document.getElementById('notesInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitScan(e);
                }
            });

            // 検索入力でEnter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadHistory();
                }
            });

            // 返却検索入力
            let returnSearchTimeout;
            document.getElementById('returnSearchInput').addEventListener('input', function(e) {
                clearTimeout(returnSearchTimeout);
                returnSearchTimeout = setTimeout(() => {
                    returnSearch = this.value.trim();
                    returnPage = 1;
                    loadReturnList();
                }, 300);
            });

            // 返却バーコードスキャン入力でEnter → 返却処理実行
            document.getElementById('returnBarcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitReturnScan();
                }
            });

        });

        // ============================================================
        // メインタブ切り替え
        // ============================================================

        function switchMainTab(tab) {
            // タブボタンの状態更新
            document.querySelectorAll('.main-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) t.classList.add('active');
            });

            // タブコンテンツの表示切り替え
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'scan') {
                document.getElementById('tabScan').classList.add('active');
                setTimeout(focusBarcodeInput, 50);
            } else {
                document.getElementById('tabReturn').classList.add('active');
                loadReturnList();
            }
        }

        // ============================================================
        // スキャン登録
        // ============================================================

        function submitScan(e) {
            e.preventDefault();

            const barcode = document.getElementById('barcodeInput').value.trim();
            const patientId = document.getElementById('patientIdInput').value.trim();
            const notes = document.getElementById('notesInput').value.trim();

            if (!barcode && !notes) {
                showToast('バーコードまたはメモを入力してください', 'error');
                return;
            }

            const data = {
                barcode: barcode,
                patient_id: patientId,
                quantity: parseInt(document.getElementById('quantityInput').value) || 1,
                notes: notes
            };

            fetch('/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('登録しました', 'success');
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('patientIdInput').value = '';
                    document.getElementById('quantityInput').value = '1';
                    document.getElementById('notesInput').value = '';
                    focusBarcodeInput();
                    loadHistory();
                    updateIncompleteCount();
                } else {
                    showToast(result.error, 'error');
                    focusBarcodeInput();
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ============================================================
        // 返却スキャン
        // ============================================================

        let pendingCreateBarcode = null; // 新規登録待ちのバーコード

        function submitReturnScan() {
            const barcode = document.getElementById('returnBarcodeInput').value.trim();

            if (!barcode) {
                showToast('バーコードを入力してください', 'error');
                return;
            }

            fetch('/return/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ barcode: barcode })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    if (result.action === 'not_found') {
                        // レコードが見つからない場合、確認モーダルを表示
                        showConfirmCreateModal(result.barcode);
                    } else {
                        // 既存レコードが見つかった場合
                        showToast(result.message, 'success');
                        document.getElementById('returnBarcodeInput').value = '';
                        document.getElementById('returnBarcodeInput').focus();
                        loadReturnList();
                        loadHistory();
                        updateIncompleteCount();

                        // 該当レコードにスクロール＆ハイライト（フォーカス）
                        if (result.item && result.item.id) {
                            setTimeout(() => {
                                const row = document.querySelector(`tr[data-id="${result.item.id}"]`);
                                if (row) {
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    row.classList.add('highlight-focus');
                                    setTimeout(() => row.classList.remove('highlight-focus'), 3000);
                                }
                            }, 200);
                        }
                    }
                } else {
                    showToast(result.error, 'error');
                    document.getElementById('returnBarcodeInput').focus();
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // 新規登録確認モーダルを表示
        function showConfirmCreateModal(barcode) {
            pendingCreateBarcode = barcode;
            document.getElementById('confirmBarcode').textContent = barcode;
            document.getElementById('confirmCreateModal').classList.add('active');
        }

        // 新規登録確認モーダルを閉じる
        function hideConfirmCreateModal() {
            pendingCreateBarcode = null;
            document.getElementById('confirmCreateModal').classList.remove('active');
            document.getElementById('returnBarcodeInput').value = '';
            document.getElementById('returnBarcodeInput').focus();
        }

        // 新規登録を実行
        function confirmCreateReturn() {
            if (!pendingCreateBarcode) {
                hideConfirmCreateModal();
                return;
            }

            fetch('/return/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ barcode: pendingCreateBarcode })
            })
            .then(response => response.json())
            .then(result => {
                hideConfirmCreateModal();

                if (result.success) {
                    showToast(result.message, 'success');
                    loadReturnList();
                    loadHistory();
                    updateIncompleteCount();

                    // 新規作成したレコードにスクロール＆ハイライト
                    if (result.item && result.item.id) {
                        setTimeout(() => {
                            const row = document.querySelector(`tr[data-id="${result.item.id}"]`);
                            if (row) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                row.classList.add('highlight-focus');
                                setTimeout(() => row.classList.remove('highlight-focus'), 3000);
                            }
                        }, 200);
                    }
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                hideConfirmCreateModal();
                showToast('エラーが発生しました', 'error');
            });
        }

        // ============================================================
        // 返却処理
        // ============================================================

        function setReturnFilter(filter) {
            returnFilter = filter;
            returnPage = 1;
            // フィルター変更時はソートを既存セレクトの値に戻す
            returnSort = document.getElementById('returnSortSelect').value;

            // 返却フィルタータブのみ更新
            document.querySelectorAll('.return-filter-tabs .filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter && !tab.classList.contains('sort-tab')) {
                    tab.classList.add('active');
                }
            });
            // ソートタブのactiveを解除
            document.querySelectorAll('.return-filter-tabs .sort-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            loadReturnList();
        }

        function setReturnSort(sort) {
            // 同じソートをクリックしたらnewestに戻す（トグル動作）
            if (returnSort === sort) {
                returnSort = document.getElementById('returnSortSelect').value;
            } else {
                returnSort = sort;
            }
            returnPage = 1;

            // ソートタブの状態更新
            document.querySelectorAll('.return-filter-tabs .sort-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.sort === returnSort) {
                    tab.classList.add('active');
                }
            });

            loadReturnList();
        }

        function loadReturnList() {
            // ソートタブが選択されていなければセレクトボックスの値を使用
            const sortTabActive = document.querySelector('.return-filter-tabs .sort-tab.active');
            const sort = sortTabActive ? returnSort : document.getElementById('returnSortSelect').value;
            const showCompleted = document.getElementById('showCompletedToggle').checked;

            // フィルター決定: フィルタータブ + 完了表示チェック
            let filterValue;
            if (showCompleted) {
                // 完了を表示: そのままフィルターを使用
                filterValue = returnFilter;
            } else {
                // 完了を非表示: 日付フィルター + incomplete の組み合わせ
                if (returnFilter === 'all') {
                    filterValue = 'incomplete';
                } else if (returnFilter === 'today') {
                    filterValue = 'today_incomplete';
                } else if (returnFilter === 'yesterday') {
                    filterValue = 'yesterday_incomplete';
                } else {
                    filterValue = returnFilter;
                }
            }

            const params = new URLSearchParams({
                filter: filterValue,
                page: returnPage,
                per_page: 30,
                sort: sort
            });

            if (returnSearch) {
                params.set('search', returnSearch);
            }

            fetch(`/history?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    renderReturnTable(data.items);
                    renderReturnPagination(data);
                    document.getElementById('incompleteCount').textContent = data.total || 0;
                })
                .catch(error => {
                    document.getElementById('returnTable').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">
                                データの読み込みに失敗しました
                            </td>
                        </tr>
                    `;
                });
        }

        function renderReturnTable(items) {
            const tbody = document.getElementById('returnTable');

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state" style="padding: 40px 0;">
                                <div class="empty-state-icon"><i class="ph ph-check-circle"></i></div>
                                <div class="empty-state-title">未完了のデータがありません</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const scannedAt = new Date(item.scanned_at);
                const blockQty = item.block_quantity || 0;
                const slideQty = item.slide_quantity || 0;
                const isComplete = item.all_returned;

                return `
                    <tr class="${isComplete ? 'completed' : ''}" data-id="${item.id}">
                        <td class="return-id">#${item.id}</td>
                        <td>
                            <div class="return-info">
                                <span class="return-barcode">${item.barcode ? escapeHtml(item.barcode) : '<span class="text-muted">バーコードなし</span>'}</span>
                                ${item.notes ? `<span class="return-notes">${escapeHtml(item.notes)}</span>` : ''}
                            </div>
                        </td>
                        <td>${item.patient_id ? escapeHtml(item.patient_id) : '<span class="text-muted">-</span>'}</td>
                        <td>${formatDateShort(scannedAt)}</td>
                        <td>
                            <button class="return-toggle ${item.preliminary_report ? 'active' : ''}"
                                    onclick="toggleReturnField(${item.id}, 'preliminary_report', ${!item.preliminary_report})">
                                <i class="ph ${item.preliminary_report ? 'ph-fill ph-check-circle' : 'ph ph-circle'}"></i>
                                ${item.preliminary_report ? '済' : '未'}
                            </button>
                        </td>
                        <td>
                            <button class="return-toggle ${item.returned ? 'active' : ''}"
                                    onclick="toggleReturnField(${item.id}, 'returned', ${!item.returned})">
                                <i class="ph ${item.returned ? 'ph-fill ph-check-circle' : 'ph ph-circle'}"></i>
                                ${item.returned ? '済' : '未'}
                            </button>
                        </td>
                        <td>
                            <div class="block-quantity-input">
                                <button type="button" class="block-stepper-btn" onclick="incrementBlockQty(${item.id}, -1)">
                                    <i class="ph-bold ph-minus"></i>
                                </button>
                                <input type="number" class="block-qty-input ${blockQty > 0 ? 'has-value' : ''}"
                                       id="block_${item.id}" value="${blockQty}" min="0">
                                <button type="button" class="block-stepper-btn" onclick="incrementBlockQty(${item.id}, 1)">
                                    <i class="ph-bold ph-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <div class="block-quantity-input">
                                <button type="button" class="block-stepper-btn" onclick="incrementSlideQty(${item.id}, -1)">
                                    <i class="ph-bold ph-minus"></i>
                                </button>
                                <input type="number" class="block-qty-input ${slideQty > 0 ? 'has-value' : ''}"
                                       id="slide_${item.id}" value="${slideQty}" min="0">
                                <button type="button" class="block-stepper-btn" onclick="incrementSlideQty(${item.id}, 1)">
                                    <i class="ph-bold ph-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <div class="actions" style="display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-icon btn-sm" onclick="showEditModal(${item.id})" title="編集">
                                    <i class="ph ph-pencil-simple"></i>
                                </button>
                                ${isComplete ? `
                                <button class="btn btn-warning btn-sm" onclick="uncompleteReturn(${item.id})" title="完了を取り消し">
                                    <i class="ph ph-arrow-counter-clockwise"></i>
                                    取消
                                </button>
                                ` : `
                                <button class="btn btn-primary btn-sm" onclick="completeReturn(${item.id})">
                                    <i class="ph ph-check"></i>
                                    完了
                                </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 結果返却フィールドの切り替え（トグル）- サーバーに保存
        function toggleReturnField(itemId, field, value) {
            // まずボタンの視覚的な状態を切り替え
            const button = document.querySelector(`button[onclick*="toggleReturnField(${itemId}"]`);
            if (button) {
                if (value) {
                    button.classList.add('active');
                    button.innerHTML = '<i class="ph ph-fill ph-check-circle"></i> 済';
                    button.setAttribute('onclick', `toggleReturnField(${itemId}, '${field}', false)`);
                } else {
                    button.classList.remove('active');
                    button.innerHTML = '<i class="ph ph-circle"></i> 未';
                    button.setAttribute('onclick', `toggleReturnField(${itemId}, '${field}', true)`);
                }
            }

            // サーバーに保存
            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    showToast(result.error, 'error');
                    // 失敗時は視覚状態を戻す
                    if (button) {
                        if (!value) {
                            button.classList.add('active');
                            button.innerHTML = '<i class="ph ph-fill ph-check-circle"></i> 済';
                            button.setAttribute('onclick', `toggleReturnField(${itemId}, '${field}', false)`);
                        } else {
                            button.classList.remove('active');
                            button.innerHTML = '<i class="ph ph-circle"></i> 未';
                            button.setAttribute('onclick', `toggleReturnField(${itemId}, '${field}', true)`);
                        }
                    }
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ブロック個数の増減（サーバーに保存）
        // ブロック個数をインクリメント/デクリメント
        function incrementBlockQty(itemId, delta) {
            const input = document.getElementById(`block_${itemId}`);
            if (!input) return;

            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + delta;
            if (newValue < 0) newValue = 0;

            changeBlockQty(itemId, newValue);
        }

        // スライド個数をインクリメント/デクリメント
        function incrementSlideQty(itemId, delta) {
            const input = document.getElementById(`slide_${itemId}`);
            if (!input) return;

            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + delta;
            if (newValue < 0) newValue = 0;

            changeSlideQty(itemId, newValue);
        }

        function changeBlockQty(itemId, value) {
            value = parseInt(value) || 0;
            if (value < 0) value = 0;
            const input = document.getElementById(`block_${itemId}`);
            if (input) {
                input.value = value;
                input.classList.toggle('has-value', value > 0);
            }

            // サーバーに保存
            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ block_quantity: value })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // スライド個数の増減（サーバーに保存）
        function changeSlideQty(itemId, value) {
            value = parseInt(value) || 0;
            if (value < 0) value = 0;
            const input = document.getElementById(`slide_${itemId}`);
            if (input) {
                input.value = value;
                input.classList.toggle('has-value', value > 0);
            }

            // サーバーに保存
            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ slide_quantity: value })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // 完了ボタン押下時に完了フラグを設定
        function completeReturn(itemId) {
            // 完了フラグを設定（completedをtrueに）
            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    completed: true
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('完了しました！', 'success');
                    loadReturnList();
                    loadHistory();
                    updateIncompleteCount();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // 完了取り消しボタン押下時
        function uncompleteReturn(itemId) {
            if (!confirm('完了を取り消しますか？')) return;

            // 完了フラグを解除（completedをfalseに）
            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    completed: false
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('完了を取り消しました', 'success');
                    loadReturnList();
                    loadHistory();
                    updateIncompleteCount();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        function renderReturnPagination(data) {
            const container = document.getElementById('returnPagination');
            if (data.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button class="page-btn" ${!data.has_prev ? 'disabled' : ''} onclick="goToReturnPage(${returnPage - 1})">‹</button>`;

            for (let i = 1; i <= data.pages; i++) {
                if (i === 1 || i === data.pages || (i >= returnPage - 2 && i <= returnPage + 2)) {
                    html += `<button class="page-btn ${i === returnPage ? 'active' : ''}" onclick="goToReturnPage(${i})">${i}</button>`;
                } else if (i === returnPage - 3 || i === returnPage + 3) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }

            html += `<button class="page-btn" ${!data.has_next ? 'disabled' : ''} onclick="goToReturnPage(${returnPage + 1})">›</button>`;
            container.innerHTML = html;
        }

        function goToReturnPage(page) {
            returnPage = page;
            loadReturnList();
        }

        function updateIncompleteCount() {
            fetch('/history?filter=incomplete&per_page=1')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('incompleteCount').textContent = data.total || 0;
                });
        }

        // ============================================================
        // 履歴一覧
        // ============================================================

        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 1;
            // フィルター変更時はソートをリセット
            currentSort = 'newest';

            // スキャン履歴のフィルタータブのみ更新
            document.querySelectorAll('#tabHistory .filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter && !tab.classList.contains('sort-tab')) {
                    tab.classList.add('active');
                }
            });
            // ソートタブのactiveを解除
            document.querySelectorAll('#tabHistory .sort-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            updateExportUrl();
            loadHistory();
        }

        function setSort(sort) {
            // 同じソートをクリックしたらnewestに戻す（トグル動作）
            if (currentSort === sort) {
                currentSort = 'newest';
            } else {
                currentSort = sort;
            }
            currentPage = 1;

            // ソートタブの状態更新
            document.querySelectorAll('#tabHistory .sort-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.sort === currentSort) {
                    tab.classList.add('active');
                }
            });

            updateExportUrl();
            loadHistory();
        }

        function updateExportUrl() {
            const params = new URLSearchParams();
            if (currentFilter !== 'all') params.set('filter', currentFilter);
            if (currentSearch) params.set('search', currentSearch);

            const exportBtn = document.getElementById('exportBtn');
            exportBtn.href = '/export/csv' + (params.toString() ? '?' + params.toString() : '');
        }

        function loadHistory() {
            currentSearch = document.getElementById('searchInput').value.trim();
            updateExportUrl();

            const params = new URLSearchParams({
                filter: currentFilter,
                page: currentPage,
                per_page: 50,
                sort: currentSort
            });

            if (currentSearch) {
                params.set('search', currentSearch);
            }

            fetch(`/history?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    renderHistory(data.items);
                    renderPagination(data);
                })
                .catch(error => {
                    document.getElementById('historyTable').innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-danger">
                                データの読み込みに失敗しました
                            </td>
                        </tr>
                    `;
                });
        }

        function renderHistory(items) {
            const tbody = document.getElementById('historyTable');

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="ph ph-package"></i></div>
                                <div class="empty-state-title">データがありません</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const scannedAt = new Date(item.scanned_at);

                return `
                    <tr>
                        <td>${item.id}</td>
                        <td><strong>${item.barcode ? escapeHtml(item.barcode) : '<span class="text-muted">-</span>'}</strong></td>
                        <td>${item.patient_id ? escapeHtml(item.patient_id) : '<span class="text-muted">-</span>'}</td>
                        <td>${item.quantity}</td>
                        <td>${escapeHtml(item.scanned_by_name || '-')}</td>
                        <td>${formatDate(scannedAt)}</td>
                        <td>${escapeHtml(item.notes || '-')}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-secondary btn-icon" onclick="showEditModal(${item.id})" title="編集">
                                    <i class="ph ph-pencil-simple"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination(data) {
            const container = document.getElementById('pagination');

            if (data.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button class="page-btn" ${!data.has_prev ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">‹</button>`;

            for (let i = 1; i <= data.pages; i++) {
                if (i === 1 || i === data.pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }

            html += `<button class="page-btn" ${!data.has_next ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">›</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadHistory();
        }

        // ============================================================
        // 編集モーダル
        // ============================================================

        function showEditModal(itemId) {
            fetch(`/item/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.item) {
                        showToast('データが見つかりません', 'error');
                        return;
                    }

                    const item = data.item;
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editBarcode').value = item.barcode || '';
                    document.getElementById('editPatientId').value = item.patient_id || '';
                    document.getElementById('editQuantity').value = item.quantity;
                    document.getElementById('editPreliminaryReport').checked = item.preliminary_report;
                    document.getElementById('editReturned').checked = item.returned;
                    document.getElementById('editBlockQuantity').value = item.block_quantity || 0;
                    document.getElementById('editSlideQuantity').value = item.slide_quantity || 0;
                    document.getElementById('editNotes').value = item.notes || '';

                    document.getElementById('editModal').classList.add('active');
                })
                .catch(error => {
                    showToast('データの取得に失敗しました', 'error');
                });
        }

        function hideEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveEdit() {
            const itemId = document.getElementById('editItemId').value;
            const data = {
                barcode: document.getElementById('editBarcode').value.trim(),
                patient_id: document.getElementById('editPatientId').value.trim(),
                quantity: parseInt(document.getElementById('editQuantity').value),
                preliminary_report: document.getElementById('editPreliminaryReport').checked,
                returned: document.getElementById('editReturned').checked,
                block_quantity: parseInt(document.getElementById('editBlockQuantity').value) || 0,
                slide_quantity: parseInt(document.getElementById('editSlideQuantity').value) || 0,
                notes: document.getElementById('editNotes').value.trim()
            };

            fetch(`/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('更新しました', 'success');
                    hideEditModal();
                    loadHistory();
                    loadReturnList();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        function deleteItem() {
            if (!confirm('この履歴を削除しますか？')) return;

            const itemId = document.getElementById('editItemId').value;

            fetch(`/delete/${itemId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('削除しました', 'success');
                    hideEditModal();
                    loadHistory();
                    loadReturnList();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ============================================================
        // バックアップ
        // ============================================================

        function runBackup() {
            showToast('バックアップを開始しています...', 'info');

            fetch('/backup/run', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('バックアップが完了しました', 'success');
                    document.getElementById('lastBackup').textContent = new Date().toLocaleString('ja-JP');
                } else {
                    showToast(result.message, 'error');
                }
            })
            .catch(error => {
                showToast('バックアップに失敗しました', 'error');
            });
        }

        // ============================================================
        // ユーティリティ
        // ============================================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date, dateOnly = false) {
            if (dateOnly) {
                return date.toLocaleDateString('ja-JP');
            }
            return date.toLocaleString('ja-JP', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('ja-JP', {
                month: '2-digit',
                day: '2-digit'
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconClass = type === 'success' ? 'ph-check' : type === 'error' ? 'ph-x' : 'ph-info';
            toast.innerHTML = `
                <i class="ph ${iconClass}"></i>
                <span>${escapeHtml(message)}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // モーダル外クリックで閉じる
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideEditModal();
            }
        });

        document.getElementById('confirmCreateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideConfirmCreateModal();
            }
        });
    </script>
</body>
</html>
