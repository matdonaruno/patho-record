<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - Patho Return</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ app_version }}">
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css" />
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="header-left">
            <a href="{{ url_for('main') }}" class="logo" style="text-decoration: none;">
                <i class="ph ph-arrow-left"></i> <i class="ph-bold ph-cube"></i> Patho Return
            </a>
        </div>
        <div class="header-right">
            <span class="user-badge">{{ user.name }}</span>
        </div>
    </header>

    <main class="main-container">
        <!-- ユーザー管理 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-users"></i> ユーザー管理</h2>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="ph ph-user-plus"></i> 新規ユーザー追加
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名前</th>
                                <th>種別</th>
                                <th>パスワード</th>
                                <th>登録日</th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            {% for u in users %}
                            <tr data-user-id="{{ u.id }}">
                                <td>{{ u.id }}</td>
                                <td>
                                    <i class="ph-fill {{ 'ph-user-circle-gear' if u.is_admin else 'ph-user-circle' }}"></i>
                                    {{ u.name }}
                                </td>
                                <td>
                                    <span class="badge {{ 'badge-warning' if u.is_admin else 'badge-info' }}">
                                        {{ '管理者' if u.is_admin else '一般' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'badge-success' if u.has_password else 'badge-secondary' }}">
                                        {% if u.has_password %}<i class="ph-fill ph-lock-simple"></i> 設定済{% else %}未設定{% endif %}
                                    </span>
                                </td>
                                <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else '-' }}</td>
                                <td>
                                    <span class="status {{ 'status-returned' if u.is_active else 'status-pending' }}">
                                        {{ '有効' if u.is_active else '無効' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editUser({{ u.id }}, '{{ u.name }}', {{ 'true' if u.is_active else 'false' }}, {{ 'true' if u.is_admin else 'false' }}, {{ 'true' if u.has_password else 'false' }})">
                                            <i class="ph ph-pencil-simple"></i> 編集
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser({{ u.id }}, '{{ u.name }}')">
                                            <i class="ph ph-trash"></i> 削除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- バックアップ情報 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-floppy-disk"></i> バックアップ</h2>
            </div>
            <div class="card-body">
                <!-- バックアップタイプ選択 -->
                <div class="mb-4" style="border-bottom: 1px solid var(--border-color); padding-bottom: 16px;">
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-swap"></i> バックアップ先</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <label class="toggle-item" style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" id="backupTypeUsb">
                            <input type="radio" name="backupType" value="usb" {{ 'checked' if backup_type == 'usb' else '' }} onchange="changeBackupType('usb')">
                            <i class="ph ph-usb"></i> USBメモリ
                        </label>
                        <label class="toggle-item" style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" id="backupTypeNas">
                            <input type="radio" name="backupType" value="nas" {{ 'checked' if backup_type == 'nas' else '' }} onchange="changeBackupType('nas')">
                            <i class="ph ph-hard-drives"></i> NAS
                        </label>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <p class="form-label">ストレージ接続状態</p>
                        <p>
                            <span class="badge {{ 'badge-success' if storage_status.connected else 'badge-danger' }}">
                                {{ '接続中' if storage_status.connected else '未接続' }}
                            </span>
                            <span class="badge badge-info" style="margin-left: 4px;">
                                {{ 'USB' if storage_status.type == 'usb' else 'NAS' }}
                            </span>
                            {% if storage_status.connected and storage_status.type == 'nas' %}
                            <br><small class="text-muted">{{ storage_status.host }} ({{ storage_status.mount_point }})</small>
                            {% elif storage_status.connected and storage_status.type == 'usb' %}
                            <br><small class="text-muted">{{ storage_status.mount_point }}</small>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="form-label">バックアップタイミング</p>
                        <p>その日の初回起動時</p>
                    </div>
                    <div>
                        <p class="form-label">保持期間</p>
                        <p>{{ config.BACKUP_RETENTION_DAYS }}日間</p>
                    </div>
                    <div>
                        <p class="form-label">デフォルト返却期限</p>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" class="form-input" id="returnDaysInput"
                                   value="{{ return_days }}" min="1" max="365"
                                   style="width: 80px; text-align: center;">
                            <span>日間</span>
                            <button class="btn btn-secondary btn-sm" onclick="saveReturnDays()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- NAS設定（NAS選択時のみ表示） -->
                <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 16px;" id="nasSettingsSection" {{ 'style=display:none;' if backup_type == 'usb' else '' }}>
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-hard-drives"></i> NAS設定</h4>
                    {% if user.is_admin %}
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                        <!-- かんたん設定 -->
                        <div style="margin-bottom: 16px;">
                            <label class="form-label" style="font-weight: bold;"><i class="ph ph-magic-wand"></i> かんたん設定</label>
                            <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">
                                NASのIPアドレスを入力して「自動検出」をクリックするだけで設定完了
                            </p>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <input type="text" class="form-input" id="nasHostSimple" placeholder="NASのIPアドレス（例: 192.168.0.100）" style="flex: 1; min-width: 200px;">
                                <button class="btn btn-primary" onclick="autoDetectNas()">
                                    <i class="ph ph-magnifying-glass"></i> 自動検出して設定
                                </button>
                            </div>
                            <div id="nasDetectResult" style="margin-top: 8px;"></div>
                        </div>

                        <!-- 現在の設定表示 -->
                        <div id="nasCurrentSettings" style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                            <label class="form-label" style="font-weight: bold;">現在の設定</label>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 16px; font-size: 0.9rem;">
                                <span class="text-muted">ホスト:</span>
                                <span id="nasHostDisplay">未設定</span>
                                <span class="text-muted">共有名:</span>
                                <span id="nasShareDisplay">未設定</span>
                                <span class="text-muted">マウント先:</span>
                                <span id="nasMountPointDisplay">未設定</span>
                            </div>
                            <div style="margin-top: 12px;">
                                <button class="btn btn-secondary btn-sm" onclick="checkStorageStatus()">
                                    <i class="ph ph-arrow-clockwise"></i> 接続テスト
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="toggleAdvancedNasSettings()">
                                    <i class="ph ph-gear"></i> 詳細設定
                                </button>
                                <span id="storageStatusResult" style="margin-left: 8px;"></span>
                            </div>
                        </div>

                        <!-- 詳細設定（折りたたみ） -->
                        <div id="nasAdvancedSettings" style="display: none; border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 12px;">
                            <label class="form-label" style="font-weight: bold;">詳細設定</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label class="form-label">ホスト (IPアドレス)</label>
                                    <input type="text" class="form-input" id="nasHost" placeholder="例: 192.168.0.100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">共有名</label>
                                    <input type="text" class="form-input" id="nasShare" placeholder="例: share">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ユーザー名 (空欄=匿名)</label>
                                    <input type="text" class="form-input" id="nasUsername" placeholder="匿名の場合は空欄">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">パスワード</label>
                                    <input type="password" class="form-input" id="nasPassword" placeholder="匿名の場合は空欄">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">マウントポイント</label>
                                    <input type="text" class="form-input" id="nasMountPoint" placeholder="例: /mnt/nas_backup">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">バックアップフォルダ</label>
                                    <input type="text" class="form-input" id="nasBackupFolder" placeholder="例: barcode_app_backups">
                                </div>
                            </div>
                            <div style="margin-top: 12px;">
                                <button class="btn btn-primary" onclick="saveNasSettings()">
                                    <i class="ph ph-floppy-disk"></i> 詳細設定を保存
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px;">
                            <span class="text-muted">ホスト:</span>
                            <span id="nasHostDisplayUser">-</span>
                            <span class="text-muted">共有名:</span>
                            <span id="nasShareDisplayUser">-</span>
                            <span class="text-muted">マウント先:</span>
                            <span id="nasMountPointDisplayUser">-</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- USB設定（USB選択時のみ表示） -->
                <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 16px;" id="usbSettingsSection" {{ '' if backup_type == 'usb' else 'style=display:none;' }}>
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-usb"></i> USB設定</h4>
                    {% if user.is_admin %}
                    <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 12px;">
                        バックアップ先USBメモリの設定です。UUIDはlsblkコマンドで確認できます。
                    </p>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label class="form-label">UUID</label>
                                <input type="text" class="form-input" id="usbUuid" placeholder="例: XXXX-XXXX">
                            </div>
                            <div class="form-group">
                                <label class="form-label">マウントポイント</label>
                                <input type="text" class="form-input" id="usbMountPoint" placeholder="例: /media/usb_backup">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="form-label">バックアップフォルダ</label>
                                <input type="text" class="form-input" id="usbBackupFolder" placeholder="例: barcode_app_backups">
                            </div>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="saveUsbSettings()">
                                <i class="ph ph-floppy-disk"></i> USB設定を保存
                            </button>
                            <button class="btn btn-secondary" onclick="checkStorageStatus()">
                                <i class="ph ph-arrow-clockwise"></i> 接続テスト
                            </button>
                            <span id="usbStatusResult" style="margin-left: 8px; line-height: 36px;"></span>
                        </div>
                    </div>
                    {% else %}
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px;">
                            <span class="text-muted">マウント先:</span>
                            <span id="usbMountPointDisplay">-</span>
                            <span class="text-muted">バックアップフォルダ:</span>
                            <span id="usbBackupFolderDisplay">-</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <button class="btn btn-primary" onclick="runBackup()">
                        今すぐバックアップ実行
                    </button>
                </div>

                <div class="mt-4">
                    <h4 style="margin-bottom: 12px;">最近のバックアップ</h4>
                    <div id="backupList">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- バックアップ検証・診断（管理者のみ） -->
        {% if user.is_admin %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-stethoscope"></i> バックアップ検証・診断</h2>
            </div>
            <div class="card-body">
                <p class="text-muted" style="margin-bottom: 16px;">
                    バックアップシステムの動作確認とデータ整合性の検証を行います。
                </p>

                <!-- 診断ボタン -->
                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="runDiagnostics()">
                        <i class="ph ph-magnifying-glass"></i> システム診断
                    </button>
                    <button class="btn btn-secondary" onclick="verifyBackup()">
                        <i class="ph ph-check-circle"></i> バックアップ検証
                    </button>
                    <button class="btn btn-primary" onclick="insertDemoData()">
                        <i class="ph ph-plus-circle"></i> デモデータ挿入＆バックアップ
                    </button>
                    <button class="btn btn-warning" onclick="cleanupDemoData()">
                        <i class="ph ph-trash"></i> デモデータ削除
                    </button>
                </div>

                <!-- 診断結果表示エリア -->
                <div id="diagnosticsResult" style="display: none;">
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-clipboard-text"></i> 診断結果</h4>
                    <div id="diagnosticsContent" style="background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                    </div>
                </div>

                <!-- 検証結果表示エリア -->
                <div id="verifyResult" style="display: none; margin-top: 16px;">
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-seal-check"></i> 検証結果</h4>
                    <div id="verifyContent" style="background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                    </div>
                </div>

                <!-- NAS直結運用設定（NAS選択時のみ） -->
                <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 16px;" id="fstabSection" {{ 'style=display:none;' if backup_type == 'usb' else '' }}>
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-terminal"></i> 自動マウント設定（直結運用）</h4>
                    <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 12px;">
                        Linux起動時にNASを自動マウントするためのfstab設定です。
                    </p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                        <button class="btn btn-primary btn-sm" onclick="addFstabEntry()">
                            <i class="ph ph-plus-circle"></i> fstabに追加してマウント
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showFstabEntry()">
                            <i class="ph ph-code"></i> エントリを確認
                        </button>
                    </div>
                    <div id="fstabResult" style="margin-bottom: 12px;"></div>
                    <div id="fstabContent" style="display: none;">
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem;"></pre>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 監査ログ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-list-checks"></i> 監査ログ（最新50件）</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>操作</th>
                                <th>テーブル</th>
                                <th>レコードID</th>
                                <th>ユーザー</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- アップデート -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-arrows-clockwise"></i> アップデート</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p class="form-label">現在のバージョン</p>
                        <p id="currentVersion" style="font-size: 1.2em; font-weight: bold;">
                            <span class="text-muted">読み込み中...</span>
                        </p>
                    </div>
                    <div>
                        <p class="form-label">最新バージョン</p>
                        <p id="latestVersion" style="font-size: 1.2em; font-weight: bold;">
                            <span class="text-muted">-</span>
                        </p>
                    </div>
                </div>

                <div id="updateStatus" style="margin-bottom: 16px;"></div>

                <div id="releaseNotes" style="display: none; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <p class="form-label"><i class="ph ph-note"></i> リリースノート</p>
                    <div id="releaseNotesContent" style="white-space: pre-wrap; font-size: 0.9em;"></div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="checkUpdate()" id="checkUpdateBtn">
                        <i class="ph ph-magnifying-glass"></i> アップデート確認
                    </button>
                    <button class="btn btn-primary" onclick="doUpdate()" id="doUpdateBtn" style="display: none;">
                        <i class="ph ph-download"></i> 今すぐ更新
                    </button>
                </div>

                <p class="text-muted mt-4" style="font-size: 0.85em;">
                    <i class="ph ph-info"></i> アップデートを確認するにはインターネット接続が必要です。<br>
                    更新後はアプリの再起動が必要な場合があります。
                </p>
            </div>
        </div>
    </main>

    <!-- ユーザー追加モーダル -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-user-plus"></i> 新規ユーザー追加</h3>
                <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-4">
                    <label class="form-label">ユーザー名</label>
                    <input type="text" class="form-input" id="newUserName" placeholder="名前を入力...">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">パスワード（任意）</label>
                    <input type="password" class="form-input" id="newUserPassword" placeholder="パスワードを設定...">
                    <small class="text-muted">空欄の場合、パスワードなしでログイン可能</small>
                </div>
                <div class="form-group">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="newUserAdmin">
                        <span>管理者権限</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddUserModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="addUser()">追加</button>
            </div>
        </div>
    </div>

    <!-- ユーザー編集モーダル -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-user-gear"></i> ユーザー編集</h3>
                <button class="modal-close" onclick="hideEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-group mb-4">
                    <label class="form-label">ユーザー名</label>
                    <input type="text" class="form-input" id="editUserName" placeholder="名前を入力...">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">新しいパスワード</label>
                    <input type="password" class="form-input" id="editUserPassword" placeholder="変更する場合のみ入力...">
                    <small class="text-muted" id="editPasswordHint">現在のパスワード: 設定済み</small>
                </div>
                <div class="form-group mb-4">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editClearPassword">
                        <span>パスワードを削除する</span>
                    </label>
                </div>
                <div class="form-group mb-4">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editUserAdmin">
                        <span>管理者権限</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editUserActive">
                        <span>有効</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideEditUserModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>

    <!-- ユーザー削除確認モーダル -->
    <div class="modal-overlay" id="deleteUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-warning"></i> ユーザー削除確認</h3>
                <button class="modal-close" onclick="hideDeleteUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteUserId">
                <p style="margin-bottom: 20px;">
                    本当に以下のユーザーを削除しますか？<br>
                    <strong style="font-size: 18px; color: var(--danger);" id="deleteUserName"></strong>
                </p>
                <p style="color: var(--text-sub); font-size: 14px;">
                    <i class="ph ph-info"></i> この操作は取り消せません。削除されたユーザーのスキャン履歴は残りますが、ユーザーとしてログインできなくなります。
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideDeleteUserModal()">キャンセル</button>
                <button class="btn btn-danger" onclick="deleteUser()">
                    <i class="ph ph-trash"></i> 削除する
                </button>
            </div>
        </div>
    </div>

    <!-- トースト -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadBackupList();
            loadAuditLogs();
            loadCurrentVersion();
        });

        // バックアップタイプ切替
        function changeBackupType(type) {
            fetch('/settings/backup-type', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ backup_type: type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`バックアップ先を${type === 'usb' ? 'USB' : 'NAS'}に変更しました`, 'success');
                    // 設定セクションの表示切替
                    document.getElementById('nasSettingsSection').style.display = type === 'nas' ? 'block' : 'none';
                    document.getElementById('usbSettingsSection').style.display = type === 'usb' ? 'block' : 'none';
                    // 選択状態の更新
                    document.getElementById('backupTypeUsb').style.borderColor = type === 'usb' ? 'var(--primary)' : 'var(--border-color)';
                    document.getElementById('backupTypeNas').style.borderColor = type === 'nas' ? 'var(--primary)' : 'var(--border-color)';
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
                console.error('バックアップタイプ変更エラー:', error);
            });
        }

        // ストレージ接続確認
        function checkStorageStatus() {
            const nasResult = document.getElementById('storageStatusResult');
            const usbResult = document.getElementById('usbStatusResult');

            if (nasResult) nasResult.innerHTML = '<span class="text-muted">確認中...</span>';
            if (usbResult) usbResult.innerHTML = '<span class="text-muted">確認中...</span>';

            fetch('/settings/storage-status')
                .then(response => response.json())
                .then(data => {
                    let resultHtml = '';
                    if (data.backup_type === 'nas') {
                        if (data.reachable && data.status.connected) {
                            resultHtml = '<span class="badge badge-success">接続OK</span>';
                        } else if (data.reachable) {
                            resultHtml = '<span class="badge badge-warning">ネットワーク到達可・マウント未完了</span>';
                        } else {
                            resultHtml = '<span class="badge badge-danger">接続不可</span>';
                        }
                        if (nasResult) nasResult.innerHTML = resultHtml;
                    } else {
                        if (data.connected) {
                            resultHtml = '<span class="badge badge-success">接続OK</span>';
                        } else {
                            resultHtml = '<span class="badge badge-danger">未接続</span>';
                        }
                        if (usbResult) usbResult.innerHTML = resultHtml;
                    }
                })
                .catch(error => {
                    const errorHtml = '<span class="badge badge-danger">確認失敗</span>';
                    if (nasResult) nasResult.innerHTML = errorHtml;
                    if (usbResult) usbResult.innerHTML = errorHtml;
                    console.error('ストレージ接続確認エラー:', error);
                });
        }

        // 初期表示時の選択状態を反映 & ストレージ設定を読み込み
        document.addEventListener('DOMContentLoaded', () => {
            const usbRadio = document.querySelector('input[name="backupType"][value="usb"]');
            const nasRadio = document.querySelector('input[name="backupType"][value="nas"]');
            if (usbRadio && usbRadio.checked) {
                document.getElementById('backupTypeUsb').style.borderColor = 'var(--primary)';
            }
            if (nasRadio && nasRadio.checked) {
                document.getElementById('backupTypeNas').style.borderColor = 'var(--primary)';
            }
            // ストレージ設定を読み込み
            loadStorageConfig();
        });

        // ストレージ設定を読み込み
        function loadStorageConfig() {
            fetch('/settings/storage-config')
                .then(response => response.json())
                .then(data => {
                    if (data.error) return;

                    // NAS設定を入力欄に反映
                    const nasHost = document.getElementById('nasHost');
                    const nasShare = document.getElementById('nasShare');
                    const nasUsername = document.getElementById('nasUsername');
                    const nasPassword = document.getElementById('nasPassword');
                    const nasMountPoint = document.getElementById('nasMountPoint');
                    const nasBackupFolder = document.getElementById('nasBackupFolder');

                    if (nasHost) nasHost.value = data.nas.host || '';
                    if (nasShare) nasShare.value = data.nas.share || '';
                    if (nasUsername) nasUsername.value = data.nas.username || '';
                    if (nasPassword) nasPassword.value = data.nas.password || '';
                    if (nasMountPoint) nasMountPoint.value = data.nas.mount_point || '';
                    if (nasBackupFolder) nasBackupFolder.value = data.nas.backup_folder || '';

                    // 一般ユーザー向け表示を更新
                    const nasHostDisplay = document.getElementById('nasHostDisplay');
                    const nasShareDisplay = document.getElementById('nasShareDisplay');
                    const nasMountPointDisplay = document.getElementById('nasMountPointDisplay');
                    if (nasHostDisplay) nasHostDisplay.textContent = data.nas.host || '(未設定)';
                    if (nasShareDisplay) nasShareDisplay.textContent = data.nas.share || '(未設定)';
                    if (nasMountPointDisplay) nasMountPointDisplay.textContent = data.nas.mount_point || '(未設定)';

                    // USB設定を入力欄に反映
                    const usbUuid = document.getElementById('usbUuid');
                    const usbMountPoint = document.getElementById('usbMountPoint');
                    const usbBackupFolder = document.getElementById('usbBackupFolder');

                    if (usbUuid) usbUuid.value = data.usb.uuid || '';
                    if (usbMountPoint) usbMountPoint.value = data.usb.mount_point || '';
                    if (usbBackupFolder) usbBackupFolder.value = data.usb.backup_folder || '';

                    // 一般ユーザー向け表示を更新
                    const usbMountPointDisplay = document.getElementById('usbMountPointDisplay');
                    const usbBackupFolderDisplay = document.getElementById('usbBackupFolderDisplay');
                    if (usbMountPointDisplay) usbMountPointDisplay.textContent = data.usb.mount_point || '(未設定)';
                    if (usbBackupFolderDisplay) usbBackupFolderDisplay.textContent = data.usb.backup_folder || '(未設定)';
                })
                .catch(error => {
                    console.error('ストレージ設定読み込みエラー:', error);
                });
        }

        // NAS設定を保存
        function saveNasSettings() {
            const data = {
                type: 'nas',
                host: document.getElementById('nasHost').value.trim(),
                share: document.getElementById('nasShare').value.trim(),
                username: document.getElementById('nasUsername').value.trim(),
                password: document.getElementById('nasPassword').value,
                mount_point: document.getElementById('nasMountPoint').value.trim(),
                backup_folder: document.getElementById('nasBackupFolder').value.trim()
            };

            if (!data.host) {
                showToast('ホスト（IPアドレス）を入力してください', 'error');
                return;
            }
            if (!data.share) {
                showToast('共有名を入力してください', 'error');
                return;
            }

            fetch('/settings/storage-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('NAS設定を保存しました', 'success');
                } else {
                    showToast(result.error || '保存に失敗しました', 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
                console.error('NAS設定保存エラー:', error);
            });
        }

        // USB設定を保存
        function saveUsbSettings() {
            const data = {
                type: 'usb',
                uuid: document.getElementById('usbUuid').value.trim(),
                mount_point: document.getElementById('usbMountPoint').value.trim(),
                backup_folder: document.getElementById('usbBackupFolder').value.trim()
            };

            fetch('/settings/storage-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('USB設定を保存しました', 'success');
                } else {
                    showToast(result.error || '保存に失敗しました', 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
                console.error('USB設定保存エラー:', error);
            });
        }

        // システム診断
        function runDiagnostics() {
            showToast('診断を実行しています...', 'info');
            const resultDiv = document.getElementById('diagnosticsResult');
            const contentDiv = document.getElementById('diagnosticsContent');
            resultDiv.style.display = 'none';

            fetch('/settings/backup-diagnostics')
                .then(response => response.json())
                .then(data => {
                    resultDiv.style.display = 'block';

                    const statusIcon = {
                        'ok': '<i class="ph ph-check-circle" style="color: var(--success);"></i>',
                        'warning': '<i class="ph ph-warning" style="color: var(--warning);"></i>',
                        'error': '<i class="ph ph-x-circle" style="color: var(--danger);"></i>',
                        'skip': '<i class="ph ph-minus-circle" style="color: var(--text-sub);"></i>'
                    };

                    let html = `<div style="margin-bottom: 12px;">
                        <span class="badge ${data.overall === 'ok' ? 'badge-success' : data.overall === 'warning' ? 'badge-warning' : 'badge-danger'}">
                            総合: ${data.overall === 'ok' ? '正常' : data.overall === 'warning' ? '警告あり' : 'エラーあり'}
                        </span>
                        <span class="badge badge-info" style="margin-left: 4px;">${data.backup_type === 'usb' ? 'USB' : 'NAS'}</span>
                        <small class="text-muted" style="margin-left: 8px;">${data.timestamp}</small>
                    </div>`;

                    html += '<table class="table" style="margin: 0;"><tbody>';
                    data.tests.forEach(test => {
                        html += `<tr>
                            <td style="width: 30px;">${statusIcon[test.status]}</td>
                            <td style="font-weight: 500;">${test.name}</td>
                            <td class="text-muted">${test.detail}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';

                    contentDiv.innerHTML = html;
                    showToast('診断完了', 'success');
                })
                .catch(error => {
                    contentDiv.innerHTML = '<span class="text-danger">診断に失敗しました</span>';
                    resultDiv.style.display = 'block';
                    showToast('診断に失敗しました', 'error');
                });
        }

        // バックアップ検証
        function verifyBackup() {
            showToast('バックアップを検証しています...', 'info');
            const resultDiv = document.getElementById('verifyResult');
            const contentDiv = document.getElementById('verifyContent');
            resultDiv.style.display = 'none';

            fetch('/settings/backup-verify', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.style.display = 'block';

                if (data.success) {
                    contentDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="ph ph-seal-check" style="font-size: 32px; color: var(--success);"></i>
                            <div>
                                <strong style="color: var(--success);">バックアップ検証成功</strong><br>
                                <small class="text-muted">ファイル: ${data.filename}</small>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px;">
                            <span class="text-muted">ローカルサイズ:</span><span>${formatBytes(data.local_size)}</span>
                            <span class="text-muted">リモートサイズ:</span><span>${formatBytes(data.remote_size)}</span>
                            ${data.hash ? `<span class="text-muted">ハッシュ:</span><span style="font-family: monospace;">${data.hash.substring(0, 16)}...</span>` : ''}
                        </div>
                    `;
                    showToast('検証成功！バックアップは正常です', 'success');
                } else {
                    contentDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="ph ph-x-circle" style="font-size: 32px; color: var(--danger);"></i>
                            <div>
                                <strong style="color: var(--danger);">バックアップ検証失敗</strong><br>
                                <small class="text-muted">${data.error}</small>
                            </div>
                        </div>
                    `;
                    showToast('検証失敗: ' + data.error, 'error');
                }
            })
            .catch(error => {
                contentDiv.innerHTML = '<span class="text-danger">検証に失敗しました</span>';
                resultDiv.style.display = 'block';
                showToast('検証に失敗しました', 'error');
            });
        }

        // デモデータ挿入
        function insertDemoData() {
            if (!confirm('デモデータを挿入してバックアップを実行しますか？')) return;

            showToast('デモデータを挿入しています...', 'info');

            fetch('/settings/insert-demo-data', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadBackupList();
                    // 自動的に検証を実行
                    setTimeout(() => verifyBackup(), 1000);
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // デモデータ削除
        function cleanupDemoData() {
            if (!confirm('すべてのデモデータを削除しますか？')) return;

            fetch('/settings/cleanup-demo-data', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // fstabエントリ自動追加
        function addFstabEntry() {
            const resultDiv = document.getElementById('fstabResult');
            resultDiv.innerHTML = '<span class="text-muted"><i class="ph ph-spinner"></i> fstab設定を追加中...</span>';

            fetch('/settings/fstab-add', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `<div class="badge badge-success" style="padding: 8px 12px;">
                        <i class="ph ph-check-circle"></i> ${data.message}
                    </div>`;
                    if (data.warning) {
                        html += `<p style="margin: 8px 0 0 0; font-size: 0.85rem; color: var(--warning);">
                            <i class="ph ph-warning"></i> ${data.warning}
                        </p>`;
                    }
                    resultDiv.innerHTML = html;
                    showToast(data.message, 'success');
                    // 接続テストを自動実行
                    setTimeout(() => checkStorageStatus(), 500);
                } else {
                    resultDiv.innerHTML = `<div class="badge badge-danger" style="padding: 8px 12px;">
                        <i class="ph ph-x-circle"></i> ${data.error}
                    </div>`;
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<span class="text-danger">エラーが発生しました</span>';
                showToast('fstab追加に失敗しました', 'error');
            });
        }

        // fstabエントリ表示
        function showFstabEntry() {
            const contentDiv = document.getElementById('fstabContent');
            const preElement = contentDiv.querySelector('pre');

            if (contentDiv.style.display === 'block') {
                contentDiv.style.display = 'none';
                return;
            }

            fetch('/settings/fstab-entry')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let text = '# バックアップNAS自動マウント設定\n';
                        text += '# 以下を /etc/fstab に追加してください:\n\n';
                        text += data.entry + '\n\n';
                        text += '# 設定後のテスト:\n';
                        text += '# sudo mount -a\n';
                        preElement.textContent = text;
                        contentDiv.style.display = 'block';
                    } else {
                        showToast(data.error, 'error');
                    }
                })
                .catch(error => {
                    showToast('取得に失敗しました', 'error');
                });
        }

        // バイトフォーマット
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ユーザー追加モーダル
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
            document.getElementById('newUserName').focus();
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserAdmin').checked = false;
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const isAdmin = document.getElementById('newUserAdmin').checked;

            if (!name) {
                showToast('名前を入力してください', 'error');
                return;
            }

            fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: name, password: password, is_admin: isAdmin })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ユーザーを追加しました', 'success');
                    hideAddUserModal();
                    location.reload();
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ユーザー編集
        function editUser(id, name, isActive, isAdmin, hasPassword) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserName').value = name;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserActive').checked = isActive;
            document.getElementById('editUserAdmin').checked = isAdmin;
            document.getElementById('editClearPassword').checked = false;
            document.getElementById('editPasswordHint').innerHTML =
                hasPassword ? '現在のパスワード: <i class="ph-fill ph-lock-simple"></i> 設定済み' : '現在のパスワード: 未設定';
            document.getElementById('editUserModal').classList.add('active');
        }

        function hideEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
        }

        function saveUser() {
            const userId = document.getElementById('editUserId').value;
            const password = document.getElementById('editUserPassword').value;
            const clearPassword = document.getElementById('editClearPassword').checked;

            const data = {
                name: document.getElementById('editUserName').value.trim(),
                is_active: document.getElementById('editUserActive').checked,
                is_admin: document.getElementById('editUserAdmin').checked
            };

            // パスワード処理
            if (clearPassword) {
                data.password = '';
                data.clear_password = true;
            } else if (password) {
                data.password = password;
            }

            fetch(`/users/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('更新しました', 'success');
                    hideEditUserModal();
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ユーザー削除関連
        function confirmDeleteUser(userId, userName) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        function hideDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('active');
        }

        function deleteUser() {
            const userId = document.getElementById('deleteUserId').value;

            fetch(`/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('ユーザーを削除しました', 'success');
                    hideDeleteUserModal();
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // 返却期限日数の保存
        function saveReturnDays() {
            const days = parseInt(document.getElementById('returnDaysInput').value);

            if (isNaN(days) || days < 1 || days > 365) {
                showToast('1〜365の範囲で入力してください', 'error');
                return;
            }

            fetch('/settings/return-days', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ days: days })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(`返却期限を${result.return_days}日に設定しました`, 'success');
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // バックアップ
        function loadBackupList() {
            fetch('/backup/status')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('backupList');

                    if (!data.backups || data.backups.length === 0) {
                        container.innerHTML = '<p class="text-muted">バックアップがありません</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ファイル名</th>
                                    <th>場所</th>
                                    <th>日時</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.backups.map(b => `
                                    <tr>
                                        <td>${b.filename}</td>
                                        <td>
                                            <span class="badge ${b.location === 'nas' ? 'badge-success' : 'badge-info'}">
                                                ${b.location === 'nas' ? 'NAS' : 'ローカル'}
                                            </span>
                                        </td>
                                        <td>${new Date(b.modified).toLocaleString('ja-JP')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                })
                .catch(error => {
                    document.getElementById('backupList').innerHTML = '<p class="text-danger">読み込みに失敗しました</p>';
                });
        }

        function runBackup() {
            showToast('バックアップを開始しています...', 'info');

            fetch('/backup/run', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('バックアップが完了しました', 'success');
                    loadBackupList();
                } else {
                    showToast(result.message, 'error');
                }
            })
            .catch(error => {
                showToast('バックアップに失敗しました', 'error');
            });
        }

        // 監査ログ
        function loadAuditLogs() {
            fetch('/audit-logs?per_page=50')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('auditLogTable');

                    if (!data.logs || data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ログがありません</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                            <td>
                                <span class="badge ${log.action === 'CREATE' ? 'badge-success' : log.action === 'DELETE' ? 'badge-danger' : 'badge-warning'}">
                                    ${log.action}
                                </span>
                            </td>
                            <td>${log.table_name}</td>
                            <td>${log.record_id}</td>
                            <td>${log.user_name || '-'}</td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    document.getElementById('auditLogTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">読み込みに失敗しました</td></tr>';
                });
        }

        // アップデート関連
        function loadCurrentVersion() {
            fetch('/settings/version')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('currentVersion').textContent = 'v' + data.version;
                })
                .catch(error => {
                    document.getElementById('currentVersion').innerHTML = '<span class="text-danger">取得失敗</span>';
                });
        }

        function checkUpdate() {
            const btn = document.getElementById('checkUpdateBtn');
            const statusDiv = document.getElementById('updateStatus');
            const latestDiv = document.getElementById('latestVersion');
            const doUpdateBtn = document.getElementById('doUpdateBtn');
            const releaseNotesDiv = document.getElementById('releaseNotes');
            const releaseNotesContent = document.getElementById('releaseNotesContent');

            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner"></i> 確認中...';
            statusDiv.innerHTML = '';
            doUpdateBtn.style.display = 'none';
            releaseNotesDiv.style.display = 'none';

            fetch('/settings/check-update')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ph ph-magnifying-glass"></i> アップデート確認';

                    if (!data.success) {
                        statusDiv.innerHTML = `<span class="badge badge-danger"><i class="ph ph-warning"></i> ${data.error}</span>`;
                        latestDiv.innerHTML = '<span class="text-muted">-</span>';
                        return;
                    }

                    latestDiv.textContent = 'v' + data.latest_version;

                    if (data.has_update) {
                        statusDiv.innerHTML = '<span class="badge badge-warning"><i class="ph ph-arrow-up"></i> 新しいバージョンがあります</span>';
                        doUpdateBtn.style.display = 'inline-flex';

                        if (data.release_notes) {
                            releaseNotesContent.textContent = data.release_notes;
                            releaseNotesDiv.style.display = 'block';
                        }
                    } else {
                        statusDiv.innerHTML = '<span class="badge badge-success"><i class="ph ph-check"></i> 最新版です</span>';
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ph ph-magnifying-glass"></i> アップデート確認';
                    statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> 確認に失敗しました</span>';
                });
        }

        function doUpdate() {
            const btn = document.getElementById('doUpdateBtn');
            const statusDiv = document.getElementById('updateStatus');

            if (!confirm('アップデートを実行しますか？\n更新後はアプリの再起動が必要な場合があります。')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner"></i> 更新中...';
            statusDiv.innerHTML = '<span class="badge badge-info"><i class="ph ph-spinner"></i> git pull 実行中...</span>';

            fetch('/settings/do-update', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-download"></i> 今すぐ更新';

                if (data.success) {
                    if (data.needs_restart) {
                        statusDiv.innerHTML = `
                            <div class="badge badge-success" style="display: block; padding: 12px;">
                                <i class="ph ph-check"></i> ${data.message}<br>
                                <small style="opacity: 0.8;">ブラウザを更新するか、アプリを再起動してください。</small>
                            </div>
                        `;
                        btn.style.display = 'none';
                        showToast('アップデート完了！再起動してください。', 'success');
                    } else {
                        statusDiv.innerHTML = '<span class="badge badge-success"><i class="ph ph-check"></i> ' + data.message + '</span>';
                        showToast(data.message, 'info');
                    }
                } else {
                    statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> ' + data.error + '</span>';
                    showToast('更新に失敗しました', 'error');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-download"></i> 今すぐ更新';
                statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> 更新に失敗しました</span>';
                showToast('更新に失敗しました', 'error');
            });
        }

        // トースト
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconClass = type === 'success' ? 'ph-check' : type === 'error' ? 'ph-x' : 'ph-info';
            toast.innerHTML = `
                <i class="ph ${iconClass}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // NAS自動検出
        function autoDetectNas() {
            const hostInput = document.getElementById('nasHostSimple');
            const resultDiv = document.getElementById('nasDetectResult');
            const host = hostInput.value.trim();

            if (!host) {
                showToast('IPアドレスを入力してください', 'error');
                hostInput.focus();
                return;
            }

            // IP形式チェック
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(host)) {
                showToast('正しいIPアドレス形式で入力してください（例: 192.168.0.100）', 'error');
                return;
            }

            resultDiv.innerHTML = '<span class="text-muted"><i class="ph ph-spinner"></i> NASを検索中...</span>';

            fetch('/settings/nas-detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ host: host })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let statusHtml = '';
                    if (data.mount_success) {
                        statusHtml = `
                            <div class="badge badge-success" style="display: inline-block; padding: 8px 12px;">
                                <i class="ph ph-check-circle"></i> ${data.message}
                            </div>
                        `;
                        showToast('NAS設定完了・マウント成功', 'success');
                    } else {
                        statusHtml = `
                            <div style="padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px;">
                                <div class="badge badge-warning" style="margin-bottom: 8px;">
                                    <i class="ph ph-warning"></i> ${data.message}
                                </div>
                                <p style="margin: 4px 0; font-size: 0.9rem; color: var(--text-sub);">
                                    ${data.mount_warning || '手動でfstab設定が必要な場合があります'}
                                </p>
                                ${data.mount_error ? `<code style="font-size: 0.8rem; color: var(--danger);">${data.mount_error}</code>` : ''}
                                <p style="margin: 8px 0 0 0; font-size: 0.85rem;">
                                    <i class="ph ph-info"></i> 「詳細設定」→「fstabエントリを表示」で手動設定できます
                                </p>
                            </div>
                        `;
                        showToast('NAS検出完了（マウントは手動設定が必要）', 'info');
                    }
                    resultDiv.innerHTML = statusHtml;

                    // 表示を更新
                    const detected = data.detected;
                    document.getElementById('nasHostDisplay').textContent = detected.host || '未設定';
                    document.getElementById('nasShareDisplay').textContent = detected.share || '未設定';
                    document.getElementById('nasMountPointDisplay').textContent = detected.mount_point || '未設定';

                    // 詳細設定の入力欄も更新
                    const nasHost = document.getElementById('nasHost');
                    const nasShare = document.getElementById('nasShare');
                    const nasMountPoint = document.getElementById('nasMountPoint');
                    if (nasHost) nasHost.value = detected.host || '';
                    if (nasShare) nasShare.value = detected.share || '';
                    if (nasMountPoint) nasMountPoint.value = detected.mount_point || '';

                    // 接続テストを自動実行
                    setTimeout(() => checkStorageStatus(), 500);
                } else {
                    resultDiv.innerHTML = `
                        <div class="badge badge-danger" style="display: inline-block; padding: 8px 12px;">
                            <i class="ph ph-x-circle"></i> ${data.error}
                        </div>
                    `;
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<span class="text-danger">検出に失敗しました</span>';
                showToast('NAS検出に失敗しました', 'error');
                console.error('NAS自動検出エラー:', error);
            });
        }

        // 詳細設定の表示切替
        function toggleAdvancedNasSettings() {
            const advancedDiv = document.getElementById('nasAdvancedSettings');
            if (advancedDiv.style.display === 'none') {
                advancedDiv.style.display = 'block';
            } else {
                advancedDiv.style.display = 'none';
            }
        }

        // Enterキーで追加
        document.getElementById('newUserName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addUser();
        });

        // モーダル外クリックで閉じる
        document.getElementById('addUserModal').addEventListener('click', function(e) {
            if (e.target === this) hideAddUserModal();
        });
        document.getElementById('editUserModal').addEventListener('click', function(e) {
            if (e.target === this) hideEditUserModal();
        });
    </script>
</body>
</html>
