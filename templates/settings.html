<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - Patho Return</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css" />
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="header-left">
            <a href="{{ url_for('main') }}" class="logo" style="text-decoration: none;">
                <i class="ph ph-arrow-left"></i> <i class="ph-bold ph-cube"></i> Patho Return
            </a>
        </div>
        <div class="header-right">
            <span class="user-badge">{{ user.name }}</span>
        </div>
    </header>

    <main class="main-container">
        <!-- ユーザー管理 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-users"></i> ユーザー管理</h2>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="ph ph-user-plus"></i> 新規ユーザー追加
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名前</th>
                                <th>種別</th>
                                <th>パスワード</th>
                                <th>登録日</th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            {% for u in users %}
                            <tr data-user-id="{{ u.id }}">
                                <td>{{ u.id }}</td>
                                <td>
                                    <i class="ph-fill {{ 'ph-user-circle-gear' if u.is_admin else 'ph-user-circle' }}"></i>
                                    {{ u.name }}
                                </td>
                                <td>
                                    <span class="badge {{ 'badge-warning' if u.is_admin else 'badge-info' }}">
                                        {{ '管理者' if u.is_admin else '一般' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'badge-success' if u.has_password else 'badge-secondary' }}">
                                        {% if u.has_password %}<i class="ph-fill ph-lock-simple"></i> 設定済{% else %}未設定{% endif %}
                                    </span>
                                </td>
                                <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else '-' }}</td>
                                <td>
                                    <span class="status {{ 'status-returned' if u.is_active else 'status-pending' }}">
                                        {{ '有効' if u.is_active else '無効' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editUser({{ u.id }}, '{{ u.name }}', {{ 'true' if u.is_active else 'false' }}, {{ 'true' if u.is_admin else 'false' }}, {{ 'true' if u.has_password else 'false' }})">
                                            <i class="ph ph-pencil-simple"></i> 編集
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser({{ u.id }}, '{{ u.name }}')">
                                            <i class="ph ph-trash"></i> 削除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- バックアップ情報 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-floppy-disk"></i> バックアップ</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <p class="form-label">NAS接続状態</p>
                        <p>
                            <span class="badge {{ 'badge-success' if nas_status.connected else 'badge-danger' }}">
                                {{ '接続中' if nas_status.connected else '未接続' }}
                            </span>
                            {% if nas_status.connected %}
                            <br><small class="text-muted">{{ nas_status.host }} ({{ nas_status.mount_point }})</small>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="form-label">バックアップタイミング</p>
                        <p>その日の初回起動時</p>
                    </div>
                    <div>
                        <p class="form-label">保持期間</p>
                        <p>{{ config.BACKUP_RETENTION_DAYS }}日間</p>
                    </div>
                    <div>
                        <p class="form-label">デフォルト返却期限</p>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" class="form-input" id="returnDaysInput"
                                   value="{{ return_days }}" min="1" max="365"
                                   style="width: 80px; text-align: center;">
                            <span>日間</span>
                            <button class="btn btn-secondary btn-sm" onclick="saveReturnDays()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- NAS設定 -->
                <div class="mt-4" style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                    <h4 style="margin-bottom: 12px;"><i class="ph ph-hard-drives"></i> NAS設定</h4>
                    <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 12px;">
                        バックアップ先NASの設定です。設定変更は.envファイルで行います。
                    </p>

                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <div id="nasConfigInfo">
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px;">
                                <span class="text-muted">ホスト:</span>
                                <span>{{ config.NAS_HOST }}</span>
                                <span class="text-muted">共有名:</span>
                                <span>{{ config.NAS_SHARE }}</span>
                                <span class="text-muted">マウント先:</span>
                                <span>{{ config.NAS_MOUNT_POINT }}</span>
                            </div>
                            <div style="margin-top: 12px;">
                                <button class="btn btn-secondary btn-sm" onclick="checkNasStatus()">
                                    <i class="ph ph-arrow-clockwise"></i> 接続確認
                                </button>
                                <span id="nasStatusResult" style="margin-left: 8px;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button class="btn btn-primary" onclick="runBackup()">
                        今すぐバックアップ実行
                    </button>
                </div>

                <div class="mt-4">
                    <h4 style="margin-bottom: 12px;">最近のバックアップ</h4>
                    <div id="backupList">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 監査ログ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-list-checks"></i> 監査ログ（最新50件）</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>操作</th>
                                <th>テーブル</th>
                                <th>レコードID</th>
                                <th>ユーザー</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- アップデート -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="ph ph-arrows-clockwise"></i> アップデート</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p class="form-label">現在のバージョン</p>
                        <p id="currentVersion" style="font-size: 1.2em; font-weight: bold;">
                            <span class="text-muted">読み込み中...</span>
                        </p>
                    </div>
                    <div>
                        <p class="form-label">最新バージョン</p>
                        <p id="latestVersion" style="font-size: 1.2em; font-weight: bold;">
                            <span class="text-muted">-</span>
                        </p>
                    </div>
                </div>

                <div id="updateStatus" style="margin-bottom: 16px;"></div>

                <div id="releaseNotes" style="display: none; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <p class="form-label"><i class="ph ph-note"></i> リリースノート</p>
                    <div id="releaseNotesContent" style="white-space: pre-wrap; font-size: 0.9em;"></div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="checkUpdate()" id="checkUpdateBtn">
                        <i class="ph ph-magnifying-glass"></i> アップデート確認
                    </button>
                    <button class="btn btn-primary" onclick="doUpdate()" id="doUpdateBtn" style="display: none;">
                        <i class="ph ph-download"></i> 今すぐ更新
                    </button>
                </div>

                <p class="text-muted mt-4" style="font-size: 0.85em;">
                    <i class="ph ph-info"></i> アップデートを確認するにはインターネット接続が必要です。<br>
                    更新後はアプリの再起動が必要な場合があります。
                </p>
            </div>
        </div>
    </main>

    <!-- ユーザー追加モーダル -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-user-plus"></i> 新規ユーザー追加</h3>
                <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-4">
                    <label class="form-label">ユーザー名</label>
                    <input type="text" class="form-input" id="newUserName" placeholder="名前を入力...">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">パスワード（任意）</label>
                    <input type="password" class="form-input" id="newUserPassword" placeholder="パスワードを設定...">
                    <small class="text-muted">空欄の場合、パスワードなしでログイン可能</small>
                </div>
                <div class="form-group">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="newUserAdmin">
                        <span>管理者権限</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddUserModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="addUser()">追加</button>
            </div>
        </div>
    </div>

    <!-- ユーザー編集モーダル -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-user-gear"></i> ユーザー編集</h3>
                <button class="modal-close" onclick="hideEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-group mb-4">
                    <label class="form-label">ユーザー名</label>
                    <input type="text" class="form-input" id="editUserName" placeholder="名前を入力...">
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">新しいパスワード</label>
                    <input type="password" class="form-input" id="editUserPassword" placeholder="変更する場合のみ入力...">
                    <small class="text-muted" id="editPasswordHint">現在のパスワード: 設定済み</small>
                </div>
                <div class="form-group mb-4">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editClearPassword">
                        <span>パスワードを削除する</span>
                    </label>
                </div>
                <div class="form-group mb-4">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editUserAdmin">
                        <span>管理者権限</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="toggle-item">
                        <input type="checkbox" class="toggle-checkbox" id="editUserActive">
                        <span>有効</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideEditUserModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>

    <!-- ユーザー削除確認モーダル -->
    <div class="modal-overlay" id="deleteUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-warning"></i> ユーザー削除確認</h3>
                <button class="modal-close" onclick="hideDeleteUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteUserId">
                <p style="margin-bottom: 20px;">
                    本当に以下のユーザーを削除しますか？<br>
                    <strong style="font-size: 18px; color: var(--danger);" id="deleteUserName"></strong>
                </p>
                <p style="color: var(--text-sub); font-size: 14px;">
                    <i class="ph ph-info"></i> この操作は取り消せません。削除されたユーザーのスキャン履歴は残りますが、ユーザーとしてログインできなくなります。
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideDeleteUserModal()">キャンセル</button>
                <button class="btn btn-danger" onclick="deleteUser()">
                    <i class="ph ph-trash"></i> 削除する
                </button>
            </div>
        </div>
    </div>

    <!-- トースト -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadBackupList();
            loadAuditLogs();
            loadCurrentVersion();
        });

        // NAS接続確認
        function checkNasStatus() {
            const resultSpan = document.getElementById('nasStatusResult');
            resultSpan.innerHTML = '<span class="text-muted">確認中...</span>';

            fetch('/settings/nas-status')
                .then(response => response.json())
                .then(data => {
                    if (data.reachable && data.status.connected) {
                        resultSpan.innerHTML = '<span class="badge badge-success">接続OK</span>';
                    } else if (data.reachable) {
                        resultSpan.innerHTML = '<span class="badge badge-warning">ネットワーク到達可・マウント未完了</span>';
                    } else {
                        resultSpan.innerHTML = '<span class="badge badge-danger">接続不可</span>';
                    }
                })
                .catch(error => {
                    resultSpan.innerHTML = '<span class="badge badge-danger">確認失敗</span>';
                    console.error('NAS接続確認エラー:', error);
                });
        }

        // ユーザー追加モーダル
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
            document.getElementById('newUserName').focus();
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserAdmin').checked = false;
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const isAdmin = document.getElementById('newUserAdmin').checked;

            if (!name) {
                showToast('名前を入力してください', 'error');
                return;
            }

            fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: name, password: password, is_admin: isAdmin })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ユーザーを追加しました', 'success');
                    hideAddUserModal();
                    location.reload();
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ユーザー編集
        function editUser(id, name, isActive, isAdmin, hasPassword) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserName').value = name;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserActive').checked = isActive;
            document.getElementById('editUserAdmin').checked = isAdmin;
            document.getElementById('editClearPassword').checked = false;
            document.getElementById('editPasswordHint').innerHTML =
                hasPassword ? '現在のパスワード: <i class="ph-fill ph-lock-simple"></i> 設定済み' : '現在のパスワード: 未設定';
            document.getElementById('editUserModal').classList.add('active');
        }

        function hideEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
        }

        function saveUser() {
            const userId = document.getElementById('editUserId').value;
            const password = document.getElementById('editUserPassword').value;
            const clearPassword = document.getElementById('editClearPassword').checked;

            const data = {
                name: document.getElementById('editUserName').value.trim(),
                is_active: document.getElementById('editUserActive').checked,
                is_admin: document.getElementById('editUserAdmin').checked
            };

            // パスワード処理
            if (clearPassword) {
                data.password = '';
                data.clear_password = true;
            } else if (password) {
                data.password = password;
            }

            fetch(`/users/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('更新しました', 'success');
                    hideEditUserModal();
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // ユーザー削除関連
        function confirmDeleteUser(userId, userName) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        function hideDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('active');
        }

        function deleteUser() {
            const userId = document.getElementById('deleteUserId').value;

            fetch(`/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('ユーザーを削除しました', 'success');
                    hideDeleteUserModal();
                    location.reload();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // 返却期限日数の保存
        function saveReturnDays() {
            const days = parseInt(document.getElementById('returnDaysInput').value);

            if (isNaN(days) || days < 1 || days > 365) {
                showToast('1〜365の範囲で入力してください', 'error');
                return;
            }

            fetch('/settings/return-days', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ days: days })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(`返却期限を${result.return_days}日に設定しました`, 'success');
                } else {
                    showToast(result.error, 'error');
                }
            })
            .catch(error => {
                showToast('エラーが発生しました', 'error');
            });
        }

        // バックアップ
        function loadBackupList() {
            fetch('/backup/status')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('backupList');

                    if (!data.backups || data.backups.length === 0) {
                        container.innerHTML = '<p class="text-muted">バックアップがありません</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ファイル名</th>
                                    <th>場所</th>
                                    <th>日時</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.backups.map(b => `
                                    <tr>
                                        <td>${b.filename}</td>
                                        <td>
                                            <span class="badge ${b.location === 'nas' ? 'badge-success' : 'badge-info'}">
                                                ${b.location === 'nas' ? 'NAS' : 'ローカル'}
                                            </span>
                                        </td>
                                        <td>${new Date(b.modified).toLocaleString('ja-JP')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                })
                .catch(error => {
                    document.getElementById('backupList').innerHTML = '<p class="text-danger">読み込みに失敗しました</p>';
                });
        }

        function runBackup() {
            showToast('バックアップを開始しています...', 'info');

            fetch('/backup/run', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('バックアップが完了しました', 'success');
                    loadBackupList();
                } else {
                    showToast(result.message, 'error');
                }
            })
            .catch(error => {
                showToast('バックアップに失敗しました', 'error');
            });
        }

        // 監査ログ
        function loadAuditLogs() {
            fetch('/audit-logs?per_page=50')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('auditLogTable');

                    if (!data.logs || data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ログがありません</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                            <td>
                                <span class="badge ${log.action === 'CREATE' ? 'badge-success' : log.action === 'DELETE' ? 'badge-danger' : 'badge-warning'}">
                                    ${log.action}
                                </span>
                            </td>
                            <td>${log.table_name}</td>
                            <td>${log.record_id}</td>
                            <td>${log.user_name || '-'}</td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    document.getElementById('auditLogTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">読み込みに失敗しました</td></tr>';
                });
        }

        // アップデート関連
        function loadCurrentVersion() {
            fetch('/settings/version')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('currentVersion').textContent = 'v' + data.version;
                })
                .catch(error => {
                    document.getElementById('currentVersion').innerHTML = '<span class="text-danger">取得失敗</span>';
                });
        }

        function checkUpdate() {
            const btn = document.getElementById('checkUpdateBtn');
            const statusDiv = document.getElementById('updateStatus');
            const latestDiv = document.getElementById('latestVersion');
            const doUpdateBtn = document.getElementById('doUpdateBtn');
            const releaseNotesDiv = document.getElementById('releaseNotes');
            const releaseNotesContent = document.getElementById('releaseNotesContent');

            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner"></i> 確認中...';
            statusDiv.innerHTML = '';
            doUpdateBtn.style.display = 'none';
            releaseNotesDiv.style.display = 'none';

            fetch('/settings/check-update')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ph ph-magnifying-glass"></i> アップデート確認';

                    if (!data.success) {
                        statusDiv.innerHTML = `<span class="badge badge-danger"><i class="ph ph-warning"></i> ${data.error}</span>`;
                        latestDiv.innerHTML = '<span class="text-muted">-</span>';
                        return;
                    }

                    latestDiv.textContent = 'v' + data.latest_version;

                    if (data.has_update) {
                        statusDiv.innerHTML = '<span class="badge badge-warning"><i class="ph ph-arrow-up"></i> 新しいバージョンがあります</span>';
                        doUpdateBtn.style.display = 'inline-flex';

                        if (data.release_notes) {
                            releaseNotesContent.textContent = data.release_notes;
                            releaseNotesDiv.style.display = 'block';
                        }
                    } else {
                        statusDiv.innerHTML = '<span class="badge badge-success"><i class="ph ph-check"></i> 最新版です</span>';
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ph ph-magnifying-glass"></i> アップデート確認';
                    statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> 確認に失敗しました</span>';
                });
        }

        function doUpdate() {
            const btn = document.getElementById('doUpdateBtn');
            const statusDiv = document.getElementById('updateStatus');

            if (!confirm('アップデートを実行しますか？\n更新後はアプリの再起動が必要な場合があります。')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner"></i> 更新中...';
            statusDiv.innerHTML = '<span class="badge badge-info"><i class="ph ph-spinner"></i> git pull 実行中...</span>';

            fetch('/settings/do-update', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-download"></i> 今すぐ更新';

                if (data.success) {
                    if (data.needs_restart) {
                        statusDiv.innerHTML = `
                            <div class="badge badge-success" style="display: block; padding: 12px;">
                                <i class="ph ph-check"></i> ${data.message}<br>
                                <small style="opacity: 0.8;">ブラウザを更新するか、アプリを再起動してください。</small>
                            </div>
                        `;
                        btn.style.display = 'none';
                        showToast('アップデート完了！再起動してください。', 'success');
                    } else {
                        statusDiv.innerHTML = '<span class="badge badge-success"><i class="ph ph-check"></i> ' + data.message + '</span>';
                        showToast(data.message, 'info');
                    }
                } else {
                    statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> ' + data.error + '</span>';
                    showToast('更新に失敗しました', 'error');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-download"></i> 今すぐ更新';
                statusDiv.innerHTML = '<span class="badge badge-danger"><i class="ph ph-warning"></i> 更新に失敗しました</span>';
                showToast('更新に失敗しました', 'error');
            });
        }

        // トースト
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconClass = type === 'success' ? 'ph-check' : type === 'error' ? 'ph-x' : 'ph-info';
            toast.innerHTML = `
                <i class="ph ${iconClass}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Enterキーで追加
        document.getElementById('newUserName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addUser();
        });

        // モーダル外クリックで閉じる
        document.getElementById('addUserModal').addEventListener('click', function(e) {
            if (e.target === this) hideAddUserModal();
        });
        document.getElementById('editUserModal').addEventListener('click', function(e) {
            if (e.target === this) hideEditUserModal();
        });
    </script>
</body>
</html>
