# Patho Return

病理検体返却管理システム - バーコードスキャンで検体の返却状況を追跡

![Demo](docs/demo.gif)

## 機能

- バーコードスキャンによる病理標本登録
- 3種類の返却状態管理（結果の返却、ブロックの返却、スライドの返却）
- 履歴検索・フィルタリング
- アプリ内アップデート機能（git pull）
- **USB/NASバックアップ切替**（設定画面から選択可能）
- **バックアップ診断・検証機能**（管理者向け）

## インストール (Linux Mint専用)

ターミナルで以下を実行:

```bash
sudo apt install -y git && git clone https://github.com/matdonaruno/patho-record.git && cd patho-record && ./install.sh
```

インストール完了後:
- デスクトップに「Patho Return」アイコンが表示されます
- アイコンをダブルクリックでアプリが起動します

## 初期設定

### 1. 初回起動

```bash
./start.sh
```

### 2. 管理者でログイン

- ユーザー名: `管理者`
- 初期パスワード: `admin`

### 3. バックアップ設定（設定画面から）

管理者でログイン → 設定画面 → バックアップセクション

#### NASの場合
| 項目 | 設定例（Buffalo NAS直結） |
|------|---------------------------|
| ホスト | `192.168.0.100` |
| 共有名 | `share` |
| マウントポイント | `/mnt/nas_backup` |
| ユーザー名 | （空欄=匿名アクセス） |

#### USBの場合
| 項目 | 設定例 |
|------|--------|
| UUID | `lsblk -o UUID` で確認 |
| マウントポイント | `/media/usb_backup` |

**設定はデータベースに保存されるため、.envファイルの編集は不要です。**

## 手動起動

```bash
cd patho-record
./start.sh
```

## アップデート

アプリ内の設定画面から「アップデートを確認」→「アップデート実行」

または手動で:

```bash
cd patho-record
git pull origin main
```

## 使い方

1. **標本登録**: メイン画面でバーコードをスキャン → 病理標本情報が登録される
2. **返却処理**: 履歴から標本を選択 → 返却状態を更新
   - 結果の返却 / ブロックの返却 / スライドの返却 の3段階
3. **履歴検索**: フィルタ機能で返却状況を絞り込み

## データ管理

### バックアップ

| 保存先 | 場所 | タイミング |
|--------|------|------------|
| ローカル | `backups/` | 毎日初回起動時 |
| NAS/USB | 設定したパス | 毎日初回起動時 |

- バックアップはアプリ起動時に自動実行
- 設定画面から手動バックアップも可能
- **バックアップ診断**: 接続状態・書き込みテストを実行
- **バックアップ検証**: MD5ハッシュでファイル整合性を確認

### 古いデータの参照

バックアップファイルを直接参照できます：

```bash
# SQLiteで開く（読み取り専用で安全に閲覧）
sqlite3 -readonly /mnt/nas_backup/barcode_app_backups/20240101_020000_app.db

# データを確認（例：検体一覧）
SELECT * FROM item_logs WHERE created_at < '2024-01-01';
```

※ DB Browser for SQLite（GUI）でも開けます

## NAS直結運用（Buffalo NAS）

Buffalo LS-WX1.0TL/R1などSMB1対応NASとLinux PCを直結する場合：

### ネットワーク設定
| 機器 | IPアドレス |
|------|-----------|
| NAS | 192.168.0.100 |
| Linux PC | 192.168.0.10 |

### 自動マウント設定（オプション）

設定画面の「fstabエントリ表示」からコピーして `/etc/fstab` に追加：

```bash
sudo nano /etc/fstab
# 表示されたエントリを追加
sudo mount -a
```

## 動作環境

- **オフライン/LAN環境専用**: インターネット接続なしで動作
- **単一端末使用**: ローカルネットワーク内での利用を想定
- **対応OS**: Linux Mint / Ubuntu

## セキュリティ

### リポジトリの安全性

このリポジトリには機密情報は含まれていません：

- `.env`（実際の設定）は `.gitignore` で除外
- データベース・ログ・バックアップファイルは除外済み
- NAS/USB設定はデータベース（AppSettings）に保存

### 初期管理者アカウント

初回起動時に自動作成されます：

- ユーザー名: `管理者`
- 初期パスワード: `admin`

**インストール後、必ずパスワードを変更してください**（設定画面 → ユーザー管理）

## 技術スタック

- Python 3 / Flask
- SQLite
- Phosphor Icons
- Vanilla JavaScript

## ライセンス

MIT
