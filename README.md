# Patho Return

病理検体返却管理システム - バーコードスキャンで検体の返却状況を追跡

![Demo](docs/demo.gif)

## 機能

- バーコードスキャンによる病理標本登録
- 3種類の返却状態管理（結果の返却、ブロックの返却、スライドの返却）
- 履歴検索・フィルタリング
- **NAS/USBバックアップ**（自動検出・ワンクリック設定）
- **アプリ内アップデート**（自動再起動対応）
- **バックアップ診断・検証機能**

## インストール (Linux Mint専用)

```bash
sudo apt install -y git && git clone https://github.com/matdonaruno/patho-record.git && cd patho-record && ./install.sh
```

インストール完了後、デスクトップの「Patho Return」アイコンをダブルクリックで起動。

## 初期設定

### 1. 管理者でログイン

- ユーザー名: `管理者`
- 初期パスワード: `admin`

**インストール後、必ずパスワードを変更してください**

### 2. NASバックアップ設定（かんたん設定）

1. 設定画面 → バックアップセクション → 「NAS」を選択
2. NAS設定の「かんたん設定」にIPアドレスを入力（例: `192.168.0.100`）
3. **「自動検出して設定」をクリック** → 共有フォルダを自動検出・設定
4. 「fstabに追加してマウント」をクリック → 自動マウント設定完了

これだけでNASバックアップが有効になります。

### 3. 動作確認

設定画面で以下を実行：
- 「システム診断」→ 全て✅ならOK
- 「今すぐバックアップ実行」→ バックアップ作成
- 「バックアップ検証」→ ファイル整合性確認

## アップデート

### アプリ内から（推奨）

1. 設定画面 → 「アップデート確認」
2. 新しいバージョンがあれば「今すぐ更新」をクリック
3. **自動でアプリ再起動 → ブラウザ自動リロード**

ターミナル操作は不要です。

### 手動の場合

```bash
cd patho-record
git pull origin main
# アプリを再起動
```

## 使い方

1. **標本登録**: メイン画面でバーコードをスキャン
2. **返却処理**: 履歴から標本を選択 → 返却状態を更新
   - 結果の返却 / ブロックの返却 / スライドの返却
3. **履歴検索**: フィルタ機能で絞り込み

## バックアップ

| 保存先 | 場所 | タイミング |
|--------|------|------------|
| ローカル | `backups/` | 毎日初回起動時 |
| NAS/USB | 設定したパス | 毎日初回起動時 |

### 管理者向け機能

| 機能 | 説明 |
|------|------|
| システム診断 | NAS接続・書き込みテスト |
| バックアップ検証 | MD5ハッシュで整合性確認 |
| fstab自動追加 | 起動時自動マウント設定 |

## NAS直結運用（Buffalo NAS）

Buffalo LS-WX1.0TL/R1などSMB1対応NASに対応。

### ネットワーク設定例

| 機器 | IPアドレス |
|------|-----------|
| NAS | 192.168.0.100 |
| Linux PC | 192.168.0.10 |

### セットアップ手順

1. NASとPCをLANケーブルで直結
2. アプリの設定画面でNASのIPを入力
3. 「自動検出して設定」→「fstabに追加してマウント」
4. 完了！

### パスワードなしsudo設定（必要な場合）

```bash
sudo visudo
# 最後に追加（usernameは実際のユーザー名に変更）:
username ALL=(ALL) NOPASSWD: /bin/mount, /bin/umount, /bin/mkdir
```

## 動作環境

- **対応OS**: Linux Mint / Ubuntu
- **オフライン対応**: インターネット接続なしで動作（アップデート確認時のみ必要）

## 技術スタック

- Python 3 / Flask
- SQLite
- Phosphor Icons
- Vanilla JavaScript

## ライセンス

MIT
